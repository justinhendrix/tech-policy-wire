<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search - Tech Policy Press Field Notes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo-container">
        <a href="/">
          <img src="/images/Tech Policy Press Logo Final-01.png" alt="Tech Policy Press">
        </a>
      </div>
      <div class="header-text">
        <a href="/" class="site-title-link"><h1>Field Notes</h1></a>
        <p class="tagline">Aggregating news, analysis, research, and primary documents related to technology policy.</p>
      </div>
      <div class="header-search">
        <form id="search-form" class="search-box" action="/search" method="get">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input type="text" id="search-input" name="q" placeholder="Search...">
        </form>
      </div>
    </div>
  </header>

  <div class="search-page">
    <div class="search-header">
      <h1 id="search-title">Search Results</h1>
      <p id="search-summary" class="search-summary"></p>
    </div>

    <div class="search-filters">
      <div class="filter-group">
        <label class="filter-label">Sections</label>
        <div class="section-checkboxes">
          <label class="checkbox-label"><input type="checkbox" name="section" value="news" checked> News</label>
          <label class="checkbox-label"><input type="checkbox" name="section" value="ideas" checked> Ideas</label>
          <label class="checkbox-label"><input type="checkbox" name="section" value="reports" checked> Reports</label>
          <label class="checkbox-label"><input type="checkbox" name="section" value="research" checked> Research</label>
          <label class="checkbox-label"><input type="checkbox" name="section" value="documents" checked> Documents</label>
          <label class="checkbox-label"><input type="checkbox" name="section" value="podcasts" checked> Podcasts</label>
        </div>
      </div>

      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-label" for="date-from">From</label>
          <input type="date" id="date-from" class="filter-input">
        </div>

        <div class="filter-group">
          <label class="filter-label" for="date-to">To</label>
          <input type="date" id="date-to" class="filter-input">
        </div>

        <div class="filter-group">
          <label class="filter-label" for="sort-by">Sort by</label>
          <select id="sort-by" class="filter-select">
            <option value="date-desc">Date (Newest)</option>
            <option value="date-asc">Date (Oldest)</option>
            <option value="source-asc">Source (A-Z)</option>
            <option value="source-desc">Source (Z-A)</option>
            <option value="title-asc">Title (A-Z)</option>
            <option value="title-desc">Title (Z-A)</option>
          </select>
        </div>

        <button type="button" id="apply-filters" class="filter-btn">Apply</button>
        <button type="button" id="reset-filters" class="filter-btn filter-btn-secondary">Reset</button>
      </div>
    </div>

    <div id="results-container">
      <p class="loading">Searching...</p>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <nav class="footer-nav">
        <ul>
          <li><a href="/">Back to Field Notes</a></li>
          <li><a href="https://techpolicy.press">Tech Policy Press</a></li>
          <li><a href="/rss">RSS</a></li>
        </ul>
      </nav>
      <div class="footer-copyright">
        <p>&copy; 2026 Tech Policy Press</p>
      </div>
    </div>
  </footer>

  <script>
    const sectionLabels = {
      news: 'News',
      ideas: 'Ideas',
      reports: 'Reports',
      research: 'Research',
      documents: 'Documents',
      podcasts: 'Podcasts'
    };

    function getFiltersFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return {
        q: params.get('q') || '',
        sections: params.get('sections') ? params.get('sections').split(',') : null,
        dateFrom: params.get('dateFrom') || '',
        dateTo: params.get('dateTo') || '',
        sort: params.get('sort') || 'date',
        order: params.get('order') || 'desc'
      };
    }

    function updateUrlWithFilters(filters) {
      const params = new URLSearchParams();
      if (filters.q) params.set('q', filters.q);
      if (filters.sections && filters.sections.length < 6) {
        params.set('sections', filters.sections.join(','));
      }
      if (filters.dateFrom) params.set('dateFrom', filters.dateFrom);
      if (filters.dateTo) params.set('dateTo', filters.dateTo);
      if (filters.sort !== 'date' || filters.order !== 'desc') {
        params.set('sort', filters.sort);
        params.set('order', filters.order);
      }
      const newUrl = `${window.location.pathname}?${params.toString()}`;
      window.history.pushState({}, '', newUrl);
    }

    function getSelectedSections() {
      const checkboxes = document.querySelectorAll('input[name="section"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    function setSelectedSections(sections) {
      const checkboxes = document.querySelectorAll('input[name="section"]');
      checkboxes.forEach(cb => {
        cb.checked = !sections || sections.includes(cb.value);
      });
    }

    function getCurrentFilters() {
      const sortValue = document.getElementById('sort-by').value;
      const [sort, order] = sortValue.split('-');
      return {
        q: document.getElementById('search-input').value.trim(),
        sections: getSelectedSections(),
        dateFrom: document.getElementById('date-from').value,
        dateTo: document.getElementById('date-to').value,
        sort,
        order
      };
    }

    function setFiltersFromUrl() {
      const filters = getFiltersFromUrl();
      document.getElementById('search-input').value = filters.q;
      setSelectedSections(filters.sections);
      document.getElementById('date-from').value = filters.dateFrom;
      document.getElementById('date-to').value = filters.dateTo;
      document.getElementById('sort-by').value = `${filters.sort}-${filters.order}`;
    }

    function renderResults(results, query) {
      const container = document.getElementById('results-container');
      const summary = document.getElementById('search-summary');

      if (results.length === 0) {
        container.innerHTML = '<p class="no-results">No results found for your search.</p>';
        summary.textContent = `No results for "${query}"`;
        return;
      }

      summary.textContent = `${results.length} result${results.length === 1 ? '' : 's'} for "${query}"`;

      container.innerHTML = '';

      results.forEach(item => {
        const div = document.createElement('div');
        div.className = 'search-result';

        const sectionTag = document.createElement('span');
        sectionTag.className = 'section-tag';
        sectionTag.textContent = sectionLabels[item.section] || item.section;
        div.appendChild(sectionTag);

        const link = document.createElement('a');
        link.href = item.url || item.profileUrl || '#';
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = item.title || 'Untitled';
        link.className = 'result-title';
        div.appendChild(link);

        const meta = document.createElement('div');
        meta.className = 'result-meta';

        const metaParts = [];
        if (item.source) metaParts.push(item.source);
        if (item.dateAdded) {
          const date = new Date(item.dateAdded);
          metaParts.push(date.toLocaleDateString());
        }
        meta.textContent = metaParts.join(' Â· ');

        div.appendChild(meta);
        container.appendChild(div);
      });
    }

    async function performSearch() {
      const filters = getFiltersFromUrl();

      if (!filters.q) {
        document.getElementById('search-title').textContent = 'Search';
        document.getElementById('search-summary').textContent = 'Enter a search term to find content across all sections.';
        document.getElementById('results-container').innerHTML = '';
        return;
      }

      document.getElementById('results-container').innerHTML = '<p class="loading">Searching...</p>';
      document.title = `"${filters.q}" - Search - Tech Policy Press Field Notes`;

      try {
        const params = new URLSearchParams();
        params.set('q', filters.q);
        if (filters.sections && filters.sections.length < 6) {
          params.set('sections', filters.sections.join(','));
        }
        if (filters.dateFrom) params.set('dateFrom', filters.dateFrom);
        if (filters.dateTo) params.set('dateTo', filters.dateTo);
        params.set('sort', filters.sort);
        params.set('order', filters.order);

        const response = await fetch(`/api/search?${params.toString()}`);
        const data = await response.json();

        renderResults(data.results || [], filters.q);
      } catch (error) {
        console.error('Search error:', error);
        document.getElementById('results-container').innerHTML = '<p class="error">Failed to search. Please try again.</p>';
      }
    }

    function applyFilters() {
      const filters = getCurrentFilters();
      if (!filters.q) return;
      updateUrlWithFilters(filters);
      performSearch();
    }

    function resetFilters() {
      const query = document.getElementById('search-input').value.trim();
      setSelectedSections(null); // Check all
      document.getElementById('date-from').value = '';
      document.getElementById('date-to').value = '';
      document.getElementById('sort-by').value = 'date-desc';
      if (query) {
        updateUrlWithFilters({ q: query, sections: null, dateFrom: '', dateTo: '', sort: 'date', order: 'desc' });
        performSearch();
      }
    }

    // Handle form submission
    document.getElementById('search-form').addEventListener('submit', (e) => {
      e.preventDefault();
      applyFilters();
    });

    // Apply and Reset buttons
    document.getElementById('apply-filters').addEventListener('click', applyFilters);
    document.getElementById('reset-filters').addEventListener('click', resetFilters);

    // Handle browser back/forward
    window.addEventListener('popstate', () => {
      setFiltersFromUrl();
      performSearch();
    });

    document.addEventListener('DOMContentLoaded', () => {
      setFiltersFromUrl();
      performSearch();
    });
  </script>
</body>
</html>
