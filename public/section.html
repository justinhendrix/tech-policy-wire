<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">Section - Tech Policy Press Field Notes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo-container">
        <a href="/">
          <img src="/images/Tech Policy Press Logo Final-01.png" alt="Tech Policy Press">
        </a>
      </div>
      <div class="header-text">
        <a href="/" class="site-title-link"><h1>Field Notes</h1></a>
        <p class="tagline">Aggregating news, analysis, research, and primary documents related to technology policy.</p>
      </div>
    </div>
  </header>

  <div class="section-page">
    <h1 id="section-title">Loading...</h1>

    <div id="items-container">
      <p class="loading">Loading...</p>
    </div>

    <div id="pagination" class="pagination"></div>
  </div>

  <footer>
    <div class="footer-content">
      <nav class="footer-nav">
        <ul>
          <li><a href="/">Back to Field Notes</a></li>
          <li><a href="https://techpolicy.press">Tech Policy Press</a></li>
        </ul>
      </nav>
      <div class="footer-copyright">
        <p>&copy; 2026 Tech Policy Press</p>
      </div>
    </div>
  </footer>

  <script>
    const sectionNames = {
      news: 'News',
      ideas: 'Ideas',
      reports: 'Reports',
      research: 'Research',
      documents: 'Documents',
      podcasts: 'Podcasts'
    };

    const ITEMS_PER_PAGE = 50;
    let currentSection = '';
    let currentPage = 1;
    let totalItems = 0;

    function getPageFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return parseInt(params.get('page')) || 1;
    }

    function updateUrl(page) {
      const url = new URL(window.location);
      if (page === 1) {
        url.searchParams.delete('page');
      } else {
        url.searchParams.set('page', page);
      }
      window.history.pushState({}, '', url);
    }

    function renderPagination() {
      const paginationContainer = document.getElementById('pagination');
      const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

      if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
      }

      let html = '';

      // Previous button
      if (currentPage > 1) {
        html += `<a href="?page=${currentPage - 1}" class="pagination-btn" data-page="${currentPage - 1}">&larr; Previous</a>`;
      }

      // Page info
      html += `<span class="pagination-info">Page ${currentPage} of ${totalPages}</span>`;

      // Next button
      if (currentPage < totalPages) {
        html += `<a href="?page=${currentPage + 1}" class="pagination-btn" data-page="${currentPage + 1}">Next &rarr;</a>`;
      }

      paginationContainer.innerHTML = html;

      // Add click handlers
      paginationContainer.querySelectorAll('.pagination-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const page = parseInt(btn.dataset.page);
          currentPage = page;
          updateUrl(page);
          loadSection();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });
    }

    async function loadSection() {
      const path = window.location.pathname;
      currentSection = path.split('/').pop();
      currentPage = getPageFromUrl();

      if (!sectionNames[currentSection]) {
        document.getElementById('section-title').textContent = 'Section Not Found';
        document.getElementById('items-container').innerHTML = '<p>Invalid section</p>';
        return;
      }

      document.getElementById('section-title').textContent = sectionNames[currentSection];
      document.getElementById('page-title').textContent = `${sectionNames[currentSection]} - Tech Policy Press Field Notes`;

      const offset = (currentPage - 1) * ITEMS_PER_PAGE;

      try {
        const response = await fetch(`/api/content/${currentSection}?limit=${ITEMS_PER_PAGE}&offset=${offset}`);
        const data = await response.json();

        const items = data.items || data;
        totalItems = data.total || items.length;

        const container = document.getElementById('items-container');
        container.innerHTML = '';

        if (!items || items.length === 0) {
          container.innerHTML = '<p>No items found</p>';
          renderPagination();
          return;
        }

        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'item';

          const link = document.createElement('a');
          link.href = item.url || '#';
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = item.title || 'Untitled';

          div.appendChild(link);

          const meta = document.createElement('div');
          meta.className = 'meta';

          // Build meta text based on available fields
          const metaParts = [];
          if (item.source) metaParts.push(item.source);
          if (currentSection === 'research' && item.authors) metaParts.push(item.authors);
          if (currentSection === 'research' && item.institutions) metaParts.push(item.institutions);
          if (item.dateAdded) {
            const date = new Date(item.dateAdded);
            metaParts.push(date.toLocaleDateString());
          }
          meta.textContent = metaParts.join(' Â· ');

          div.appendChild(meta);
          container.appendChild(div);
        });

        renderPagination();

      } catch (error) {
        console.error('Error loading section:', error);
        document.getElementById('items-container').innerHTML = '<p class="error">Failed to load content</p>';
      }
    }

    // Handle browser back/forward
    window.addEventListener('popstate', () => {
      loadSection();
    });

    document.addEventListener('DOMContentLoaded', loadSection);
  </script>
</body>
</html>
